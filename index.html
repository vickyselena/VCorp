<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VCorp - Inventory Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #F8FAFC;
      --card: #FFFFFF;
      --primary: #1E293B;
      --green: #10B981;
      --yellow: #F59E0B;
      --red: #EF4444;
      --gray: #64748B;
      --light: #F1F5F9;
      --sidebar: #FFFFFF;
      --radius: 20px;
      --shadow: 0 10px 30px -8px rgba(0,0,0,0.08);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); font-family:'Inter',sans-serif; color:var(--primary); display:flex; min-height:100vh; }

    /* SIDEBAR */
    .sidebar {
      width: 280px;
      background: var(--sidebar);
      padding: 2rem;
      box-shadow: var(--shadow);
      position: fixed;
      left: 0; top: 0; bottom: 0;
      z-index: 100;
      border-right: 1px solid #E2E8F0;
    }
    .logo {
      font-family: 'Outfit', sans-serif;
      font-size: 2.2rem;
      font-weight: 900;
      margin-bottom: 3rem;
      display: block;
    }
    .logo span { color:#94A3B8; font-weight:400; font-style:italic; }

    .nav-menu { margin-top: 2rem; }
    .nav-item {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      border-radius: 16px;
      color: var(--gray);
      font-weight: 500;
      margin-bottom: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
      text-decoration: none;
    }
    .nav-item:hover {
      background: #F1F5F9;
      color: var(--primary);
      transform: translateX(8px);
    }
    .nav-item.active {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    .nav-item.active .icon { color: white; }
    .icon {
      font-size: 1.3rem;
      margin-right: 14px;
      width: 28px;
      text-align: center;
    }

    /* MAIN CONTENT */
    .main-content {
      margin-left: 280px;
      flex: 1;
      padding: 3rem;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3rem;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .avatar {
      width: 52px; height: 52px;
      background: var(--green);
      color: white;
      border-radius: 50%;
      font-weight: 700;
      font-size: 1.4rem;
      display: grid;
      place-items: center;
    }

    .stats-grid, .charts-grid { /* sama seperti sebelumnya */ }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }
    .stat-card { background:var(--card); padding:2rem; border-radius:var(--radius); box-shadow:var(--shadow); position:relative; overflow:hidden; transition:.3s; }
    .stat-card:hover { transform:translateY(-8px); }
    .stat-card::before { content:''; position:absolute; top:0; left:0; width:6px; height:100%; background:var(--green); }
    .stat-card.yellow::before { background:var(--yellow); }
    .stat-card.red::before { background:var(--red); }
    .stat-label { font-size:0.9rem; color:var(--gray); text-transform:uppercase; letter-spacing:1px; font-weight:600; margin-bottom:1rem; }
    .stat-value { font-family:'Outfit',sans-serif; font-size:3rem; font-weight:900; }

    .charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:2rem; }
    .chart-card { background:var(--card); padding:2rem; border-radius:var(--radius); box-shadow:var(--shadow); }
    .chart-title { font-family:'Outfit',sans-serif; font-size:1.4rem; font-weight:700; margin-bottom:1.5rem; }
    .chart-container { position:relative; height:340px; }

    @media (max-width: 1100px) {
      .sidebar { width: 90px; padding: 2rem 1rem; }
      .logo, .nav-text { display:none; }
      .nav-item { justify-content:center; }
      .main-content { margin-left:90px; }
    }
    @media (max-width: 768px) {
      .charts-grid { grid-template-columns:1fr; }
      .sidebar { position:fixed; bottom:0; top:auto; width:100%; height:80px; padding:1rem; flex-direction:row; border-right:none; border-top:1px solid #E2E8F0; }
      .nav-menu { display:flex; width:100%; justify-content:space-around; margin-top:0; }
      .main-content { margin-left:0; padding-bottom:100px; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">VC<span>orp</span></div>
    <nav class="nav-menu">
      <a href="index.html" class="nav-item active">
        <span class="icon">‚äû</span>
        <span class="nav-text">Dashboard</span>
      </a>
      <a href="inventory.html" class="nav-item">
        <span class="icon">üì¶</span>
        <span class="nav-text">Inventaris</span>
      </a>
      <a href="stock-in.html" class="nav-item">
        <span class="icon">‚Üì</span>
        <span class="nav-text">Stock In</span>
      </a>
      <a href="stock-out.html" class="nav-item">
        <span class="icon">‚Üë</span>
        <span class="nav-text">Stock Out</span>
      </a>

      <div style="margin-top:auto; padding-top:2rem; border-top:1px solid #E2E8F0; margin-top:2rem;">
        <a href="users.html" class="nav-item" id="menuUsers" style="display:none">
          <span class="icon">üë•</span>
          <span class="nav-text">Kelola User</span>
        </a>
        <a href="#" id="logout" class="nav-item" style="color:var(--red)">
          <span class="icon">‚èª</span>
          <span class="nav-text">Logout</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <div class="header">
      <div>
        <h1 style="font-family:Outfit; font-size:2.2rem; font-weight:900;">Dashboard</h1>
        <p style="color:var(--gray); margin-top:8px;">Selamat datang kembali, <span id="userName">Vicky</span>!</p>
      </div>
      <div class="user-info">
        <div style="text-align:right">
          <div id="userRole" style="font-weight:600; color:var(--green)">Administrator</div>
          <div style="color:var(--gray); font-size:0.9rem">Online</div>
        </div>
        <div class="avatar" id="userAvatar">V</div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Item</div>
        <div class="stat-value" id="totalItems">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Stok</div>
        <div class="stat-value" id="totalStok">0</div>
      </div>
      <div class="stat-card red">
        <div class="stat-label">Rusak / Hilang</div>
        <div class="stat-value" id="rusak">0</div>
      </div>
      <div class="stat-card yellow">
        <div class="stat-label">Top Kategori</div>
        <div class="stat-value" id="topKategori" style="font-size:2rem">-</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">Proporsi Kategori</div>
        <div class="chart-container"><canvas id="chartKategori"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Kondisi Aset Saat Ini</div>
        <div class="chart-container"><canvas id="chartKondisi"></canvas></div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const app = initializeApp({
    apiKey: "AIzaSyDnmmQWABHvOEuEWe9-C-s8U7fLMlHnqTc",
    authDomain: "vcorp.firebaseapp.com",
    databaseURL: "https://vcorp-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "vcorp"
  });

  const db = getDatabase(app);
  const auth = getAuth(app);

  // Auth + Role Check
  onAuthStateChanged(auth, user => {
    if (!user) return location.href = "login.html";

    const nama = user.displayName || user.email.split('@')[0];
    document.getElementById('userName').textContent = nama;
    document.getElementById('userAvatar').textContent = nama[0].toUpperCase();

    // Cek role dari Firebase
    onValue(ref(db, 'users/' + user.uid + '/role'), snap => {
      const role = snap.val() || 'Staff';
      document.getElementById('userRole').textContent = role;
      if (role === 'Admin') {
        document.getElementById('menuUsers').style.display = 'flex';
      }
    });
  });

  document.getElementById('logout').onclick = () => {
    if (confirm('Yakin ingin logout?')) signOut(auth);
  };

  // Data Realtime
  const inventarisRef = ref(db, 'inventaris');
  let chartKat, chartKond;

  onValue(inventarisRef, snap => {
    const data = snap.val() || {};
    const items = Object.values(data);
    let stok = 0, rusak = 0;
    const kat = {}, kond = {Baik:0, 'Perlu Servis':0, Rusak:0};

    items.forEach(i => {
      const j = Number(i.jumlah) || 0;
      stok += j;
      if (i.kondisi === 'Rusak') rusak += j;
      kat[i.kategori || 'Lainnya'] = (kat[i.kategori || 'Lainnya'] || 0) + j;
      kond[i.kondisi || 'Baik'] = (kond[i.kondisi || 'Baik'] || 0) + j;
    });

    document.getElementById('totalItems').textContent = items.length.toLocaleString('id-ID');
    document.getElementById('totalStok').textContent = stok.toLocaleString('id-ID');
    document.getElementById('rusak').textContent = rusak.toLocaleString('id-ID');
    document.getElementById('topKategori').textContent = Object.keys(kat).sort((a,b) => kat[b]-kat[a])[0] || '-';

    // Chart update (sama seperti sebelumnya)
    if (!chartKat) {
      chartKat = new Chart('chartKategori', {type:'doughnut', data:{labels:Object.keys(kat), datasets:[{data:Object.values(kat), backgroundColor:['#10B981','#3B82F6','#8B5CF6','#F59E0B','#EF4444'], borderWidth:0}]}, options:{plugins:{legend:{position:'right'}}, cutout:'65%'}});
    } else {
      chartKat.data.labels = Object.keys(kat);
      chartKat.data.datasets[0].data = Object.values(kat);
      chartKat.update('quiet');
    }

    if (!chartKond) {
      chartKond = new Chart('chartKondisi', {type:'bar', data:{labels:Object.keys(kond), datasets:[{data:Object.values(kond), backgroundColor:['#10B981','#F59E0B','#EF4444'], borderRadius:12}]}, options:{plugins:{legend:{display:false}}}});
    } else {
      chartKond.data.labels = Object.keys(kond);
      chartKond.data.datasets[0].data = Object.values(kond);
      chartKond.update('quiet');
    }
  });
</script>

</body>
</html>
