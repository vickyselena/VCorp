<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VCorp - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@700;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#F8FAFC;--card:#fff;--primary:#1E293B;--green:#10B981;--yellow:#F59E0B;--red:#EF4444;--gray:#64748B;--radius:20px;--shadow:0 10px 30px -8px rgba(0,0,0,.08)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);font-family:'Inter',sans-serif;color:var(--primary);display:flex;min-height:100vh}
    .sidebar{width:280px;background:var(--card);padding:2rem;box-shadow:var(--shadow);position:fixed;height:100%;border-right:1px solid #e2e8f0}
    .logo{font-family:'Outfit',sans-serif;font-size:2.2rem;font-weight:900;margin-bottom:3rem}
    .logo span{color:#94a3b8;font-style:italic;font-weight:400}
    .nav-item{display:flex;align-items:center;padding:14px 20px;border-radius:16px;color:var(--gray);font-weight:500;margin-bottom:8px;transition:.3s;cursor:pointer;text-decoration:none}
    .nav-item:hover{background:#f1f5f9;color:var(--primary);transform:translateX(8px)}
    .nav-item.active{background:var(--primary);color:white}
    .main{margin-left:280px;padding:3rem;flex:1}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:3rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.5rem;margin-bottom:3rem}
    .stat-card{background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow);position:relative;overflow:hidden;transition:.3s}
    .stat-card:hover{transform:translateY(-8px)}
    .stat-card::before{content:'';position:absolute;top:0;left:0;width:6px;height:100%;background:var(--green)}
    .stat-card.yellow::before{background:var(--yellow)}.stat-card.red::before{background:var(--red)}
    .stat-label{font-size:.9rem;color:var(--gray);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:1rem}
    .stat-value{font-family:'Outfit',sans-serif;font-size:3rem;font-weight:900}
    .charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:2rem}
    .chart-card{background:var(--card);padding:2rem;border-radius:var(--radius);box-shadow:var(--shadow)}
    .chart-title{font-family:'Outfit',sans-serif;font-size:1.4rem;font-weight:700;margin-bottom:1.5rem}
    .chart-container{position:relative;height:340px}
    @media(max-width:1100px){.sidebar{width:90px;padding:2rem 1rem}.logo,.nav-text{display:none}.main{margin-left:90px}}
  </style>
</head>
<body>

<aside class="sidebar">
  <div class="logo">VC<span>orp</span></div>
  <nav style="margin-top:2rem">
    <a href="index.html" class="nav-item active">‚äû Dashboard</a>
    <a href="inventory.html" class="nav-item">üì¶ Inventaris</a>
    <a href="stock-in.html" class="nav-item">‚Üì Stock In</a>
    <a href="stock-out.html" class="nav-item">‚Üë Stock Out</a>
    <div style="margin-top:auto;padding-top:2rem;border-top:1px solid #e2e8f0">
      <a href="users.html" id="menuAdmin" class="nav-item" style="display:none">üë• Kelola User</a>
      <a href="#" id="logout" class="nav-item" style="color:var(--red)">‚èª Logout</a>
    </div>
  </nav>
</aside>

<div class="main">
  <div class="header">
    <div>
      <h1 style="font-family:Outfit;font-size:2.4rem;font-weight:900">Dashboard</h1>
      <p style="color:var(--gray)">Selamat datang kembali, <span id="userName">...</span>!</p>
    </div>
    <div style="display:flex;align-items:center;gap:15px">
      <div style="text-align:right">
        <div id="userRole" style="font-weight:600;color:var(--green)">Staff</div>
      </div>
      <div class="avatar" id="userAvatar" style="width:52px;height:52px;background:var(--green);color:white;border-radius:50%;font-weight:700;font-size:1.4rem;display:grid;place-items:center">V</div>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="stat-label">Total Item</div><div class="stat-value" id="totalItems">0</div></div>
    <div class="stat-card"><div class="stat-label">Total Stok</div><div class="stat-value" id="totalStok">0</div></div>
    <div class="stat-card red"><div class="stat-label">Rusak/Hilang</div><div class="stat-value" id="rusak">0</div></div>
    <div class="stat-card yellow"><div class="stat-label">Top Kategori</div><div class="stat-value" id="topKat">-</div></div>
  </div>

  <div class="charts-grid">
    <div class="chart-card"><div class="chart-title">Proporsi Kategori</div><div class="chart-container"><canvas id="chartKat"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">Kondisi Aset</div><div class="chart-container"><canvas id="chartKond"></canvas></div></div>
  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase-config.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  onAuthStateChanged(auth, user => {
    if (!user) return location.href = "login.html";
    const nama = user.displayName || user.email.split('@')[0];
    document.getElementById('userName').textContent = nama;
    document.getElementById('userAvatar').textContent = nama[0].toUpperCase();

    onValue(ref(db, 'users/' + user.uid + '/role'), s => {
      const role = s.val() || 'Staff';
      document.getElementById('userRole').textContent = role;
      if (role === 'Admin') document.getElementById('menuAdmin').style.display = 'block';
    });
  });

  document.getElementById('logout').onclick = () => confirm('Logout?') && signOut(auth);

  let chart1, chart2;
  onValue(ref(db, 'inventaris'), snap => {
    const data = snap.val() || {};
    const items = Object.values(data);
    let stok = 0, rusak = 0;
    const kat = {}, kond = {Baik:0,'Perlu Servis':0,Rusak:0};

    items.forEach(i => {
      const j = Number(i.jumlah)||0;
      stok += j;
      if (i.kondisi === 'Rusak') rusak += j;
      kat[i.kategori || 'Lainnya'] = (kat[i.kategori || 'Lainnya']||0) + j;
      kond[i.kondisi || 'Baik'] = (kond[i.kondisi || 'Baik']||0) + j;
    });

    document.getElementById('totalItems').textContent = items.length;
    document.getElementById('totalStok').textContent = stok.toLocaleString('id-ID');
    document.getElementById('rusak').textContent = rusak.toLocaleString('id-ID');
    document.getElementById('topKat').textContent = Object.keys(kat).sort((a,b)=>kat[b]-kat[a])[0] || '-';

    if (!chart1) chart1 = new Chart('chartKat', {type:'doughnut', data:{labels:Object.keys(kat), datasets:[{data:Object.values(kat), backgroundColor:['#10B981','#3B82F6','#8B5CF6','#F59E0B','#EF4444']}]}, options:{plugins:{legend:{position:'right'}}, cutout:'65%'}});
    else { chart1.data.labels = Object.keys(kat); chart1.data.datasets[0].data = Object.values(kat); chart1.update('quiet'); }

    if (!chart2) chart2 = new Chart('chartKond', {type:'bar', data:{labels:Object.keys(kond), datasets:[{data:Object.values(kond), backgroundColor:['#10B981','#F59E0B','#EF4444'], borderRadius:12}]}, options:{plugins:{legend:{display:false}}}});
    else { chart2.data.labels = Object.keys(kond); chart2.data.datasets[0].data = Object.values(kond); chart2.update('quiet'); }
  });
</script>
</body>
</html>
