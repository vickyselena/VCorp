<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kelola User - VCorp</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #F8FAFC;
      --card: #FFFFFF;
      --primary: #1E293B;
      --green: #10B981;
      --yellow: #F59E0B;
      --red: #EF4444;
      --gray: #64748B;
      --radius: 20px;
      --shadow: 0 10px 30px -8px rgba(0,0,0,0.08);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); font-family:'Inter',sans-serif; color:var(--primary); display:flex; min-height:100vh; }

    .sidebar {
      width: 280px; background: var(--card); padding: 2rem; box-shadow: var(--shadow);
      position: fixed; left:0; top:0; bottom:0; z-index:100; border-right:1px solid #E2E8F0;
    }
    .logo { font-family:'Outfit',sans-serif; font-size:2.2rem; font-weight:900; margin-bottom:3rem; }
    .logo span { color:#94A3B8; font-weight:400; font-style:italic; }
    .nav-item { display:flex; align-items:center; padding:14px 20px; border-radius:16px; color:var(--gray); font-weight:500; margin-bottom:8px; transition:.3s; text-decoration:none; }
    .nav-item:hover { background:#F1F5F9; color:var(--primary); transform:translateX(8px); }
    .nav-item.active { background:var(--primary); color:white; font-weight:600; }

    .main-content { margin-left:280px; flex:1; padding:3rem; }
    .header { margin-bottom:2rem; }
    .header h1 { font-family:'Outfit',sans-serif; font-size:2.4rem; font-weight:900; }
    .btn { padding:12px 24px; border-radius:12px; font-weight:600; cursor:pointer; border:none; transition:.3s; }
    .btn-primary { background:var(--green); color:white; }
    .btn-primary:hover { background:#059669; }

    .table-container {
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
    }
    table { width:100%; border-collapse:collapse; }
    th { background:#F8FAFC; text-align:left; padding:1.5rem 1.5rem; font-weight:600; color:var(--primary); border-bottom:2px solid #E2E8F0; }
    td { padding:1.5rem; border-bottom:1px solid #E2E8F0; }
    tr:hover { background:#F8FAFC; }
    .role-badge {
      padding:6px 14px; border-radius:50px; font-size:0.85rem; font-weight:600;
    }
    .role-admin { background:#FEE2E2; color:#991B1B; }
    .role-staff { background:#ECFDF5; color:#065F46; }
    .action-btn { padding:8px 12px; margin:0 4px; border:none; border-radius:8px; cursor:pointer; font-size:0.9rem; }
    .edit-btn { background:#DBEAFE; color:#1D4ED8; }
    .delete-btn { background:#FEE2E2; color:#991B1B; }

    .modal {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000;
      align-items:center; justify-content:center;
    }
    .modal-content {
      background:var(--card); padding:2rem; border-radius:var(--radius); width:90%; max-width:500px;
      box-shadow:0 20px 50px rgba(0,0,0,0.2);
    }
    input, select { width:100%; padding:12px 16px; margin:10px 0; border:1px solid #E2E8F0; border-radius:12px; font-size:1rem; }

    @media (max-width:1100px) {
      .sidebar { width:90px; padding:2rem 1rem; }
      .logo, .nav-text { display:none; }
      .main-content { margin-left:90px; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">VC<span>orp</span></div>
    <nav style="margin-top:2rem">
      <a href="index.html" class="nav-item">‚äû Dashboard</a>
      <a href="inventory.html" class="nav-item">üì¶ Inventaris</a>
      <a href="stock-in.html" class="nav-item">‚Üì Stock In</a>
      <a href="stock-out.html" class="nav-item">‚Üë Stock Out</a>
      <div style="margin-top:auto; padding-top:2rem; border-top:1px solid #E2E8F0;">
        <a href="users.html" class="nav-item active">üë• Kelola User</a>
        <a href="#" id="logout" class="nav-item" style="color:var(--red)">‚èª Logout</a>
      </div>
    </nav>
  </aside>

  <!-- MAIN -->
  <div class="main-content">
    <div class="header">
      <div>
        <h1>Kelola User</h1>
        <p style="color:var(--gray)">Tambah, edit, atau hapus akun staff</p>
      </div>
      <button class="btn btn-primary" onclick="openModal()">+ Tambah User</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Nama</th>
            <th>Email</th>
            <th>Role</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="userList">
          <!-- Data user akan muncul otomatis dari Firebase -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- MODAL TAMBAH/EDIT USER -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <h2 id="modalTitle">Tambah User Baru</h2>
      <input type="text" id="userNama" placeholder="Nama lengkap">
      <input type="email" id="userEmail" placeholder="Email">
      <input type="password" id="userPass" placeholder="Password (kosongkan jika edit)">
      <select id="userRole">
        <option value="Staff">Staff</option>
        <option value="Admin">Admin</option>
      </select>
      <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end">
        <button class="btn" style="background:#E2E8F0; color:#475569" onclick="closeModal()">Batal</button>
        <button class="btn btn-primary" onclick="saveUser()">Simpan</button>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
  import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const app = initializeApp({
    apiKey: "AIzaSyDnmmQWABHvOEuEWe9-C-s8U7fLMlHnqTc",
    authDomain: "vcorp.firebaseapp.com",
    databaseURL: "https://vcorp-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "vcorp"
  });

  const db = getDatabase(app);
  const auth = getAuth(app);
  let currentEditUid = null;

  // Cek login & role
  onAuthStateChanged(auth, user => {
    if (!user) return location.href = "login.html";
    
    onValue(ref(db, 'users/' + user.uid + '/role'), snap => {
      if (snap.val() !== 'Admin') {
        alert('Hanya Admin yang bisa akses halaman ini!');
        location.href = "index.html";
      }
    });
  });

  document.getElementById('logout').onclick = () => confirm('Logout?') && signOut(auth);

  // Tampilkan semua user
  onValue(ref(db, 'users'), snap => {
    const users = snap.val() || {};
    const tbody = document.getElementById('userList');
    tbody.innerHTML = '';

    Object.entries(users).forEach(([uid, data]) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="font-weight:600">${data.nama || '-'}</td>
        <td>${data.email || '-'}</td>
        <td><span class="role-badge role-${data.role === 'Admin' ? 'admin' : 'staff'}">${data.role || 'Staff'}</span></td>
        <td>
          <button class="action-btn edit-btn" onclick="editUser('${uid}', ${JSON.stringify(data).split('"').join('&quot;')})">Edit</button>
          <button class="action-btn delete-btn" onclick="deleteUser('${uid}')">Hapus</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });

  // Modal functions
  window.openModal = () => {
    currentEditUid = null;
    document.getElementById('modalTitle').textContent = 'Tambah User Baru';
    document.getElementById('userNama').value = '';
    document.getElementById('userEmail').value = '';
    document.getElementById('userPass').value = '';
    document.getElementById('userPass').placeholder = 'Password (wajib)';
    document.getElementById('userModal').style.display = 'flex';
  };

  window.closeModal = () => {
    document.getElementById('userModal').style.display = 'none';
  };

  window.editUser = (uid, data) => {
    currentEditUid = uid;
    document.getElementById('modalTitle').textContent = 'Edit User';
    document.getElementById('userNama').value = data.nama || '';
    document.getElementById('userEmail').value = data.email || '';
    document.getElementById('userPass').value = '';
    document.getElementById('userPass').placeholder = 'Kosongkan jika tidak ingin ganti password';
    document.getElementById('userRole').value = data.role || 'Staff';
    document.getElementById('userModal').style.display = 'flex';
  };

  window.saveUser = async () => {
    const nama = document.getElementById('userNama').value.trim();
    const email = document.getElementById('userEmail').value.trim();
    const pass = document.getElementById('userPass').value;
    const role = document.getElementById('userRole').value;

    if (!nama || !email) return alert('Nama dan email wajib diisi!');

    try {
      let uid = currentEditUid;

      if (!uid) {
        // Buat user baru
        const cred = await createUserWithEmailAndPassword(auth, email, pass || '123456');
        uid = cred.user.uid;
      }

      // Simpan ke database
      await set(ref(db, 'users/' + uid), {
        nama, email, role,
        updatedAt: new Date().toISOString()
      });

      alert('User berhasil disimpan!');
      closeModal();
    } catch (err) {
      alert('Error: ' + err.message);
    }
  };

  window.deleteUser = async (uid) => {
    if (!confirm('Yakin hapus user ini?')) return;
    await remove(ref(db, 'users/' + uid));
    alert('User berhasil dihapus');
  };
</script>

</body>
</html>
